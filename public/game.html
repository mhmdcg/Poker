<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Table</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="game-container">
        <!-- Header -->
        <div class="game-header">
            <div class="room-info">
                <h2>Room: <span id="roomId"></span></h2>
                <p>Share this code with friends: <strong id="roomCode"></strong></p>
            </div>
            <div class="game-status">
                <span id="gameState">Waiting for players...</span>
                <span id="round">-</span>
            </div>
        </div>

        <!-- Poker Table -->
        <div class="poker-table">
            <!-- Community Cards -->
            <div class="community-cards">
                <div class="pot-info">
                    <div class="pot">Pot: $<span id="potAmount">0</span></div>
                    <div class="current-bet">Current Bet: $<span id="currentBet">0</span></div>
                </div>
                <div class="cards" id="communityCards"></div>
            </div>

            <!-- Player Positions -->
            <div class="player-positions">
                <!-- Position 1 (Bottom) -->
                <div class="player-position bottom" id="pos-0">
                    <div class="player-info">
                        <div class="player-name">-</div>
                        <div class="player-chips">$0</div>
                        <div class="player-bet">$0</div>
                    </div>
                    <div class="player-cards" id="cards-0"></div>
                    <div class="player-status" id="status-0"></div>
                </div>

                <!-- Position 2 (Bottom Right) -->
                <div class="player-position bottom-right" id="pos-1">
                    <div class="player-info">
                        <div class="player-name">-</div>
                        <div class="player-chips">$0</div>
                        <div class="player-bet">$0</div>
                    </div>
                    <div class="player-cards" id="cards-1"></div>
                    <div class="player-status" id="status-1"></div>
                </div>

                <!-- Position 3 (Right) -->
                <div class="player-position right" id="pos-2">
                    <div class="player-info">
                        <div class="player-name">-</div>
                        <div class="player-chips">$0</div>
                        <div class="player-bet">$0</div>
                    </div>
                    <div class="player-cards" id="cards-2"></div>
                    <div class="player-status" id="status-2"></div>
                </div>

                <!-- Position 4 (Top Right) -->
                <div class="player-position top-right" id="pos-3">
                    <div class="player-info">
                        <div class="player-name">-</div>
                        <div class="player-chips">$0</div>
                        <div class="player-bet">$0</div>
                    </div>
                    <div class="player-cards" id="cards-3"></div>
                    <div class="player-status" id="status-3"></div>
                </div>

                <!-- Position 5 (Top) -->
                <div class="player-position top" id="pos-4">
                    <div class="player-info">
                        <div class="player-name">-</div>
                        <div class="player-chips">$0</div>
                        <div class="player-bet">$0</div>
                    </div>
                    <div class="player-cards" id="cards-4"></div>
                    <div class="player-status" id="status-4"></div>
                </div>

                <!-- Position 6 (Top Left) -->
                <div class="player-position top-left" id="pos-5">
                    <div class="player-info">
                        <div class="player-name">-</div>
                        <div class="player-chips">$0</div>
                        <div class="player-bet">$0</div>
                    </div>
                    <div class="player-cards" id="cards-5"></div>
                    <div class="player-status" id="status-5"></div>
                </div>

                <!-- Position 7 (Left) -->
                <div class="player-position left" id="pos-6">
                    <div class="player-info">
                        <div class="player-name">-</div>
                        <div class="player-chips">$0</div>
                        <div class="player-bet">$0</div>
                    </div>
                    <div class="player-cards" id="cards-6"></div>
                    <div class="player-status" id="status-6"></div>
                </div>

                <!-- Position 8 (Bottom Left) -->
                <div class="player-position bottom-left" id="pos-7">
                    <div class="player-info">
                        <div class="player-name">-</div>
                        <div class="player-chips">$0</div>
                        <div class="player-bet">$0</div>
                    </div>
                    <div class="player-cards" id="cards-7"></div>
                    <div class="player-status" id="status-7"></div>
                </div>
            </div>
        </div>

        <!-- Player Actions -->
        <div class="player-actions" id="playerActions">
            <div class="action-buttons">
                <button class="btn btn-fold" id="foldBtn">Fold</button>
                <button class="btn btn-call" id="callBtn">Call</button>
                <button class="btn btn-raise" id="raiseBtn">Raise</button>
                <button class="btn btn-allin" id="allInBtn">All In</button>
            </div>
            <div class="raise-controls" id="raiseControls">
                <input type="range" id="raiseSlider" min="20" max="1000" value="20" step="10">
                <span id="raiseAmount">$20</span>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat-section">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Type a message...">
                <button id="sendChat">Send</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io(gameConfig.backendUrl);
        let currentPlayer = null;
        let gameState = null;
        let roomId = null;

        // Get room ID and player name from URL
        const urlParams = new URLSearchParams(window.location.search);
        const playerName = urlParams.get('player');
        roomId = window.location.pathname.split('/').pop();

        document.getElementById('roomId').textContent = roomId;
        document.getElementById('roomCode').textContent = roomId;

        // Join the game
        socket.emit('joinGame', { roomId, playerName });

        // Socket event handlers
        socket.on('joinedGame', (data) => {
            if (data.success) {
                currentPlayer = playerName;
                gameState = data.gameState;
                updateGameDisplay();
                addChatMessage('System', `${playerName} joined the game!`);
            } else {
                alert(data.message);
                window.location.href = '/';
            }
        });

        socket.on('gameUpdate', (newGameState) => {
            gameState = newGameState;
            updateGameDisplay();
        });

        socket.on('playerJoined', (data) => {
            addChatMessage('System', `${data.player} joined the game!`);
        });

        // Action button handlers
        document.getElementById('foldBtn').addEventListener('click', () => {
            socket.emit('playerAction', { action: 'fold' });
        });

        document.getElementById('callBtn').addEventListener('click', () => {
            socket.emit('playerAction', { action: 'call' });
        });

        document.getElementById('raiseBtn').addEventListener('click', () => {
            const amount = parseInt(document.getElementById('raiseSlider').value);
            socket.emit('playerAction', { action: 'raise', amount });
        });

        document.getElementById('allInBtn').addEventListener('click', () => {
            socket.emit('playerAction', { action: 'allIn' });
        });

        // Raise slider
        document.getElementById('raiseSlider').addEventListener('input', (e) => {
            document.getElementById('raiseAmount').textContent = `$${e.target.value}`;
        });

        // Chat
        document.getElementById('sendChat').addEventListener('click', sendChat);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChat();
            }
        });

        function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                addChatMessage(currentPlayer, message);
                input.value = '';
            }
        }

        function addChatMessage(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updateGameDisplay() {
            if (!gameState) return;

            // Update game status
            document.getElementById('gameState').textContent = gameState.gameState === 'waiting' ? 'Waiting for players...' : 'Game in progress';
            document.getElementById('round').textContent = gameState.round.charAt(0).toUpperCase() + gameState.round.slice(1);
            
            // Update pot and current bet
            document.getElementById('potAmount').textContent = gameState.pot;
            document.getElementById('currentBet').textContent = gameState.currentBet;

            // Update community cards
            const communityCardsDiv = document.getElementById('communityCards');
            communityCardsDiv.innerHTML = '';
            gameState.communityCards.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card';
                cardDiv.textContent = card.toString();
                communityCardsDiv.appendChild(cardDiv);
            });

            // Update player positions
            for (let i = 0; i < 8; i++) {
                const player = gameState.players[i];
                const posDiv = document.getElementById(`pos-${i}`);
                const nameDiv = posDiv.querySelector('.player-name');
                const chipsDiv = posDiv.querySelector('.player-chips');
                const betDiv = posDiv.querySelector('.player-bet');
                const cardsDiv = document.getElementById(`cards-${i}`);
                const statusDiv = document.getElementById(`status-${i}`);

                if (player) {
                    nameDiv.textContent = player.name;
                    chipsDiv.textContent = `$${player.chips}`;
                    betDiv.textContent = player.currentBet > 0 ? `$${player.currentBet}` : '';
                    
                    // Show player's cards (only for current player)
                    if (player.name === currentPlayer) {
                        cardsDiv.innerHTML = '<div class="card">ðŸ‚ </div><div class="card">ðŸ‚ </div>';
                    } else {
                        cardsDiv.innerHTML = '<div class="card back">ðŸ‚ </div><div class="card back">ðŸ‚ </div>';
                    }

                    // Status indicators
                    let status = '';
                    if (player.folded) status = 'FOLDED';
                    if (player.allIn) status = 'ALL IN';
                    if (player.isDealer) status = 'DEALER';
                    if (player.isCurrentPlayer) status = 'YOUR TURN';
                    statusDiv.textContent = status;
                    statusDiv.className = 'player-status ' + (status ? status.toLowerCase().replace(' ', '-') : '');

                    posDiv.style.display = 'block';
                } else {
                    posDiv.style.display = 'none';
                }
            }

            // Update action buttons
            const currentPlayerData = gameState.players.find(p => p.name === currentPlayer);
            if (currentPlayerData && gameState.gameState === 'playing') {
                const isCurrentTurn = currentPlayerData.isCurrentPlayer;
                const canAct = !currentPlayerData.folded && !currentPlayerData.allIn;
                
                document.getElementById('playerActions').style.display = isCurrentTurn && canAct ? 'block' : 'none';
                
                if (isCurrentTurn && canAct) {
                    const callAmount = gameState.currentBet - currentPlayerData.currentBet;
                    document.getElementById('callBtn').textContent = callAmount > 0 ? `Call $${callAmount}` : 'Check';
                    
                    // Update raise slider
                    const raiseSlider = document.getElementById('raiseSlider');
                    raiseSlider.min = Math.max(gameState.bigBlind, gameState.currentBet + gameState.bigBlind);
                    raiseSlider.max = currentPlayerData.chips;
                    raiseSlider.value = raiseSlider.min;
                    document.getElementById('raiseAmount').textContent = `$${raiseSlider.value}`;
                }
            } else {
                document.getElementById('playerActions').style.display = 'none';
            }
        }
    </script>
</body>
</html>
